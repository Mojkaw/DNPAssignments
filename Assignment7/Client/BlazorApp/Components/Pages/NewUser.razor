@using BlazorApp.Services
@page "/users/new"
@using ApiContracts
@inject IUserService Users
@inject NavigationManager Nav


<h2>New User</h2>

@if (_error is not null)
{
    <div class="alert alert-danger">@_error</div>
}

<EditForm Model="_model" OnValidSubmit="CreateAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="mb-2">
        <label>Username</label>
        <InputText class="form-control" @bind-Value="_model.Username" />
    </div>
    <div class="mb-2">
        <label>Password</label>
        <InputText type="password" class="form-control" @bind-Value="_model.Password" />
    </div>
    <button class="btn btn-success" disabled="@_busy">Create</button>
</EditForm>

@code {
    private CreateUserDto _model = new() { Username = "", Password = "" };
    private string? _error;
    private bool _busy;

    private async Task CreateAsync()
    {
        if (_busy) return;
        _busy = true;
        try
        {
            var u = await Users.AddUserAsync(_model);
            Nav.NavigateTo("/"); // go back to posts
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _busy = false; }
    }
}